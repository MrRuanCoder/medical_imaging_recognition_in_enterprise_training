<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>用户管理</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      text-align: center;
      color: #fff;
    }

    table {
      padding: 2vh;
      /* min-width: 9in; */
      /* min-height: 7cm; */
      border: 2px solid #fff;
      /* color: #eee; */
      border-radius: 1cm;
      background: rgba(255, 255, 255, .01);
      box-shadow: inset 2px 2px 1cm rgba(255, 255, 255, .5), inset -2px -2px 1cm rgba(255, 255, 255, .5);
      /* display: flex; */
      /* flex-direction: column; */
      /* gap: 1cm; */
      /* align-items: center; */
      /* justify-content: center; */
    }

    td {
      color: #eee;
    }

    body {
      background: linear-gradient(#4a96cd, #7cb6dd, #4a96cd);
      height: 100vh;
      width: 100vw;
      padding: 0;
      margin: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-direction: column;
    }

    button,
    input,
    select,
    textarea,
    option {
      /* button, input, select, textarea */
      color: black;
    }

    b {
      padding: .5rem;
      background: rgba(0, 0, 0, 0.5);
      color: #fff;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      border-radius: 1em;
      font-size: 2vmax;
    }

    th,
    td,
    button,
    input,
    select,
    textarea,
    option {
      font-size: 2vmax;
      /* padding: 0 1em; */
    }

    button {
      cursor: pointer;
      padding: 0 1ex;
    }

    select,
    option {
      cursor: pointer;
    }

    button:first-child:not(:only-child) {
      margin-right: 1mm;
    }

    td:nth-child(4) {
      padding: 1ex 1em;
    }

    h1 {
      margin-bottom: 8px;
      font-size: 3vmax;
    }
  </style>
</head>

<body>
  <!-- <div id="box"> -->

  <table>
    <caption align="top">
      <h1>用户管理</h1>
    </caption>
    <tr>
      <th style="display: none;">工号</th>
      <th>姓名</th>
      <th>密码</th>
      <th>权限</th>
      <th>操作</th>
    </tr>
  </table>
  <!-- </div> -->
</body>

</html>
<script>
  const toggle = params => {
    let p = document.createElement("b")
    p.innerHTML = params
    document.body.appendChild(p)
    setTimeout(() => {
      p.remove()
    }, 2e3)
    p.onclick = () => p.remove()
  }
  function checkString (str, reg) {
    var regex = /^[a-zA-Z0-9]*$/;
    return !reg.test(str);
  }
  const selectStr = '<select><option value="请选择">请选择</option><option value="0">管理员</option><option value="1">普通用户</option></select>'
  const table = document.querySelector('table');
  const tableFetch = () =>
    fetch('api/all').then(e => e.json()).then(e => {
      const trs = table.querySelectorAll('tr')

      for (let i = 1; i < trs.length; i++) {
        trs[i].remove()
      }
      setTimeout(() => {
        e.users.forEach(item => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
        <td style='display:none'>${item.id}</td>
        <td>${item.username}</td>
        <td>${item.password}</td>
        <td>${item.permission == 1 ? "普通用户" : "管理员"}</td>
        <td><button onclick="del(${item.id})">删除</button><button onclick="modify(${item.id},this)">修改</button></td>
      `
          table.appendChild(tr);
        })
        const tr = document.createElement('tr')
        tr.innerHTML = `<td><input placeholder=姓名></td><td><input placeholder=密码></td><td>${selectStr}</td><td><button onclick="add(this)">添加</button></td>`
        table.appendChild(tr)
      })
    })
  function del (id) {
    if (!confirm('确定删除？')) return;
    fetch('api/delete', {
      method: 'DELETE',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ id: id })
    }).then(e => e.json()).then(e => {
      toggle('删除成功')
      tableFetch()
    }).catch(e => {
      toggle('删除失败')
    })
  }
  function modify (id, e) {
    e.innerText = '保存'
    e.removeAttribute('onclick')
    e.onclick = () => save(id, e)
    const tds = e.parentNode.parentNode.querySelectorAll('td')
    for (let i = 0; i < 3; i++) {
      tds[i].innerHTML = `<input value="${tds[i].innerText}">`
    }
    const select = tds[3]
    const selectData = select.innerText
    select.innerHTML = selectStr
    select.querySelector('select').value = selectData == "管理员" ? "0" : "1"
  }
  function save (id, e) {
    fetch('api/update', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        id: id,
        username: e.parentNode.parentNode.querySelectorAll('td')[1].querySelector('input').value,
        password: e.parentNode.parentNode.querySelectorAll('td')[2].querySelector('input').value,
        permission: e.parentNode.parentNode.querySelectorAll('td')[3].querySelector('select').value
      })
    }).then(e => e.json()).then(e => {
      toggle('修改成功')
      tableFetch()
    }).catch(e => {
      toggle('修改失败')
    })
  }
  function add (e) {
    const td = e.parentNode.parentNode.querySelectorAll('td')
    // const id = td[0].querySelector('input')
    const name = td[0].querySelector('input')
    const password = td[1].querySelector('input')
    const permission = td[2].querySelector('select')

    // if (id.value === '') {
    //   toggle('工号不能为空')
    //   td[0].querySelector('input').focus()
    //   return
    // }
    // if (checkString(id.value, /^\d+$/)) {
    //   toggle('账号只能为数字');
    //   id.focus();
    //   return;
    // }
    if (name.value === '') {
      toggle('姓名不能为空')
      td[2].querySelector('input').focus()
      return
    }
    if (password.value === '') {
      toggle('密码不能为空')
      td[1].querySelector('input').focus()
      return
    }
    if (checkString(password.value, /^[!#$&(-,.0-:<-\[\]^`-~\-]+$/)) {
      toggle('密码格式不正确');
      password.focus();
      return;
    }

    if (permission.value === '请选择') {
      toggle('请选择权限')
      td[3].querySelector('select').focus()
      return
    }

    fetch('api/add', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        // id: id.value,
        password: password.value,
        username: name.value,
        permission: permission.value
      })
    }).then(e => e.json()).then(e => {
      toggle('添加成功')
      tableFetch()
    }).catch(e => {
      toggle('添加失败')
    })
  };
  setTimeout(() => {
    tableFetch()
  });
</script>